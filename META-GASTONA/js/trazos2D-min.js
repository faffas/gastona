/*
trazos2D-min.js
is part of the open source project https://github.com/wakeupthecat/gastona

Copyright (C) 2015,2016,2017 Alejandro Xalabarder Aulet
License : GNU General Public License (GPL) version 3

This program is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.
*/

function vec3(t,e,r){this.x=t||0,this.y=e||0,this.z=r||0}function vec3FromTo(t,e){var r=e.clone();return r.minus(t),r}function vec3FromArray(t,e,r){var n=new vec3;return n.fromArray(t,e,r),n}function trazos2D(){function t(t,e,r,n){function s(){if(!n||n.length<2)return[];var s,o=3*(2+n.length)-4,l=0;a=[];for(var u=new vec3,h=new vec3(t,e),c=new vec3,f=new vec3,v=0;v<n.length-3;v+=2)v>0&&h.fromArray(n,v/2-1,2),c.fromArray(n,v/2+0,2),f.fromArray(n,v/2+1,2),h.plus(u),c.plus(h),f.plus(c),u.set(h.x,h.y,h.z),s=i(h,c,f),h.setIntoArray(a,l+0,2),s[0].setIntoArray(a,l+2,2),s[1].setIntoArray(a,l+4,2),l+=3;return r?(o+=6,h=new vec3(t,e),s=i(c,f,h),c.setIntoArray(a,l+0,2),s[0].setIntoArray(a,l+2,2),f.setIntoArray(a,l+3,2),s[1].setIntoArray(a,l+4,2),c.fromArray(n,0,2),c.plus(h),s=i(f,h,c),s[0].setIntoArray(a,l+5,2),h.setIntoArray(a,l+6,2),s[1].setIntoArray(a,1,2)):(h=f.clone(),h.plus(vec3FromTo(c,f)),s=i(c,f,h),c.setIntoArray(a,l+0,2),s[0].setIntoArray(a,l+2,2),f.setIntoArray(a,l+3,2),h.set(t,e),c.fromArray(n,0,2),c.plus(h),f=h.clone(),f.plus(vec3FromTo(c,h)),s=i(f,h,c),s[0].setIntoArray(a,1,2)),o!==a.length&&alert("Error calculating final array NP "+o+" !== "+a.length),a}function i(t,e,r){var n=new vec3,s=new vec3,i=vec3FromTo(t,e),a=vec3FromTo(r,e),u=i.norm(),h=a.norm(),c=(u+h)*(u+h),f=vec3FromTo(a,i);f.div(c);var v=u>h?u*u:h*h,y=u*h,g=u/h;return 0>o&&(o=g>1?1/g:g),f.mult(l*(o*v+(1-o)*y)),n.set(e),s.set(e),n.minus(f),s.plus(f),[n,s]}var a=[],o=-1,l=.5;return{x0:t,y0:e,arrPtos:n,computePoints:s,getArrayCasteljau:function(){return a}}}function e(t,e,n,s){s=s||10;var i=r(t),a=e*(1-2*s/100)/i.dx,o=n*(1-2*s/100)/i.dy;return o>a?o=a:a=o,{scalex:a,scaley:o,offsetx:-i.x+s/100*i.dx,offsety:-i.y+s/100*i.dy}}function r(t){function e(t,e){return null==u?(u=t,a=e,o=t+1,void(l=e+1)):(u>t&&(u=t),t>o&&(o=t+1),a>e&&(a=e),void(e>l&&(l=e+1)))}function r(t){for(n=t[1],s=t[2],e(n,s),i=5;i+1<t.length;i+=2)n+=t[i],s+=t[i+1],e(n,s)}var n,s,i,a,o,l,u=null;for(var h in t)"z"===t[h][0]&&r(t[h]);return{x:u,y:a,dx:o-u,dy:l-a}}function n(e,r,n,s,i,a,o,l){if(e.beginPath(),e.moveTo(n,s),"jau"===r){var u=t(n,s,o,l);u.computePoints();for(var h=u.getArrayCasteljau(),c=2;c+5<h.length;c+=6)e.bezierCurveTo(h[c],h[c+1],h[c+2],h[c+3],h[c+4],h[c+5])}else{for(var c=0;c<l.length;)if("pol"===r)e.lineTo(l[c],l[c+1]),c+=2;else if("qua"==r)e.quadraticCurveTo(l[c],l[c+1],l[c+2],l[c+3]),c+=4;else{if("cub"!=r&&"bez"!=r){console.log("ERROR: unknow form "+r+" calling trazoShape!");break}e.bezierCurveTo(l[c],l[c+1],l[c+2],l[c+3],l[c+4],l[c+5]),c+=6}o&&e.closePath()}i&&(e.fillStyle=i),a&&(e.strokeStyle=a),i&&e.fill(),a&&e.stroke()}function s(t,r,s){function i(t){return t}var a=r.getContext("2d"),o={};if(s){var l=e(t,r.width,r.height);a.save(),a.lineWidth=1/l.scalex,a.scale(l.scalex,l.scaley),a.translate(l.offsetx,l.offsety)}for(var u in t)t[u]&&t[u].length>=3&&("defstyle"===t[u][0]?o[t[u][1]]=i(t[u][2]):"z"!==t[u][0]||t[u].length<6||n(a,t[u][4].substring(0,3),t[u][1],t[u][2],o[t[u][3]]||t[u][3],"#000000",t[u][4].length>3&&"z"===t[u][4].substring(3),t[u].slice(5)));s&&a.restore()}function i(e,r,n,s,i,a,o,l){var u=document.createElementNS(h,"path");u.setAttribute("stroke",a||"#000000"),u.setAttribute("fill",i||"none");var c=["M "+n+" "+s+" "];if("jau"===r){var f=t(n,s,o,l);f.computePoints();var v=f.getArrayCasteljau();c.push(" C ");for(var y=2;y+5<v.length;y+=6)c.push(v[y]+" "+v[y+1]+" "+v[y+2]+" "+v[y+3]+" "+v[y+4]+" "+v[y+5]+" ")}else{"pol"===r?c.push(" L "):"qua"==r?c.push(" Q "):("cub"==r||"bez"==r)&&c.push(" C ");for(var y=0;y<l.length;)if("pol"===r)c.push(l[y]+" "+l[y+1]+" "),y+=2;else if("qua"==r)c.push(l[y]+" "+l[y+1]+" "+l[y+2]+" "+l[y+3]+" "),y+=4;else{if("cub"!=r&&"bez"!=r){console.log("ERROR: unknow form "+r+" calling trazoShape!");break}c.push(l[y]+" "+l[y+1]+" "+l[y+2]+" "+l[y+3]+" "+l[y+4]+" "+l[y+5]+" "),y+=6}o&&c.push(" Z")}u.setAttribute("d",c.join("")),e.appendChild(u)}function a(t,r,n){function s(t){return t}var a={},o=document.createElementNS(h,"g");if(n){var l=parseInt(r.style.width||c),u=parseInt(r.style.height||f);r.width&&r.width.baseVal&&(l=parseInt(r.width.baseVal.value)),r.height&&r.height.baseVal&&(u=parseInt(r.height.baseVal.value));var v=e(t,l,u);o.setAttribute("stroke-width",""+1/v.scalex),o.setAttribute("transform"," scale     ("+v.scalex+", "+v.scaley+") translate ("+v.offsetx+", "+v.offsety+")")}r.appendChild(o);for(var y in t)t[y]&&t[y].length>=3&&("defstyle"===t[y][0]?a[t[y][1]]=s(t[y][2]):"z"!==t[y][0]||t[y].length<6||i(o,t[y][4].substring(0,3),t[y][1],t[y][2],a[t[y][3]]||t[y][3],"#000000",t[y][4].length>3&&"z"==t[y][4].substring(3),t[y].slice(5)));console.log(r)}function o(t){var e,r=!!window.SVGSVGElement,n=[].slice.call(document.getElementsByClassName("graffiti"),0),i="";for(var o in n)if(i=n[o].id+" graffiti",t[i]){var l=parseInt(n[o].style.width||c),u=parseInt(n[o].style.height||f);for(e=r?document.createElementNS(h,"svg"):document.createElement("canvas"),e.setAttribute("width",l+"px"),e.setAttribute("height",u+"px"),r?a(t[i],e,!0):s(t[i],e,!0);n[o].hasChildNodes();)n[o].removeChild(n[o].firstChild);n[o].appendChild(e)}}function l(t){var e=[].slice.call(document.getElementsByTagName("canvas"),0),r="";for(var n in e)r=e[n].id+" graffiti",t[r]&&s(t[r],e[n],!0)}function u(t){var e=[].slice.call(document.getElementsByTagNameNS(h,"svg"));for(var r in e)grafo=e[r].id+" graffiti",t[grafo]&&a(t[grafo],e[r],!0)}var h="http://www.w3.org/2000/svg",c=300,f=150;return{renderCanvasGraffitis:l,renderSvgGraffitis:u,renderClassGraffiti:o,drawGrafitti2canvas:s,trazoShape2canvas:n,drawGrafitti2svg:a,trazoShape2svg:i,autoCasteljau:t}}vec3.prototype={toString:function(){return this.x+", "+this.y+", "+this.z},fromArray:function(t,e,r){r=r||3;var n=(e||0)*r;this.set(t[n],t[1+n],r>2?t[2+n]:0)},setIntoArray:function(t,e,r){r=r||3,e=e||t.length/r;var n=e*r;t[n]=this.x,t[n+1]=this.y,r>2&&(t[n+2]=this.z)},plus:function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},minus:function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},mult:function(t){this.x*=t,this.y*=t,this.z*=t},div:function(t){0===t&&(t=1e-20),this.x/=t,this.y/=t,this.z/=t},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){return new vec3(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},norm:function(){return Math.sqrt(this.dot(this))},normalize:function(){this.div(this.norm())},angle:function(t){return Math.acos(this.dot(t)/(this.norm()*t.norm()))},clone:function(){return new vec3(this.x,this.y,this.z)},set:function(t,e,r){t instanceof vec3?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=r||0)}};
