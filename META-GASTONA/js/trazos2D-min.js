/*
trazos2D-min.js
is part of the open source project https://github.com/wakeupthecat/gastona

Copyright (C) 2015,2016,2017,2018 Alejandro Xalabarder Aulet
License : GNU General Public License (GPL) version 3

This program is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.
*/

function vec3(t,e,r){this.x=t||0,this.y=e||0,this.z=r||0}function vec3FromTo(t,e){var r=e.clone();return r.minus(t),r}function vec3FromArray(t,e,r){var i=new vec3;return i.fromArray(t,e,r),i}function trazos2D(){function t(t){var e={};if(!t)return e;var r=t.split(";");if(!r||0===r.length)return e;for(var i={op:"opacity",sc:"stroke",sw:"stroke-width",so:"stroke-opacity",fc:"fill",fr:"fill-rule",fo:"fill-opacity",font:"font-family",ff:"font-family",fof:"font-family",fs:"font-size",fos:"font-size",ft:"font-type",fot:"font-type"},n=0;n<r.length;n++){var s=r[n].split(":");if(2===s.length){var a=s[0].trim();e[i[a]||a]=s[1].trim()}}return e}function e(t,e,r,i){function n(t,e,r){var i=new vec3,n=new vec3,s=vec3FromTo(t,e),l=vec3FromTo(r,e),f=s.norm(),u=l.norm(),c=(f+u)*(f+u),h=vec3FromTo(l,s);c>0&&h.div(c);var v=f>u?f*f:u*u,y=f*u,d=u>0?f/u:1;return a<0&&(a=d>1?1/d:d),h.mult(o*(a*v+(1-a)*y)),i.set(e),n.set(e),i.minus(h),n.plus(h),[i,n]}var s=[],a=-1,o=.5;return{x0:t,y0:e,arrPtos:i,computePoints:function(){if(!i||i.length<2)return[];var a,o=3*(2+i.length)-4,l=0;s=[];for(var f=new vec3,u=new vec3(t,e),c=new vec3,h=new vec3,v=0;v<i.length-3;v+=2)v>0&&u.fromArray(i,v/2-1,2),c.fromArray(i,v/2+0,2),h.fromArray(i,v/2+1,2),u.plus(f),c.plus(u),h.plus(c),f.set(u.x,u.y,u.z),a=n(u,c,h),u.setIntoArray(s,l+0,2),a[0].setIntoArray(s,l+2,2),a[1].setIntoArray(s,l+4,2),l+=3;return r?(o+=6,a=n(c,h,u=new vec3(t,e)),c.setIntoArray(s,l+0,2),a[0].setIntoArray(s,l+2,2),h.setIntoArray(s,l+3,2),a[1].setIntoArray(s,l+4,2),c.fromArray(i,0,2),c.plus(u),(a=n(h,u,c))[0].setIntoArray(s,l+5,2),u.setIntoArray(s,l+6,2),a[1].setIntoArray(s,1,2)):((u=h.clone()).plus(vec3FromTo(c,h)),a=n(c,h,u),c.setIntoArray(s,l+0,2),a[0].setIntoArray(s,l+2,2),h.setIntoArray(s,l+3,2),u.set(t,e),c.fromArray(i,0,2),c.plus(u),(h=u.clone()).plus(vec3FromTo(c,u)),(a=n(h,u,c))[0].setIntoArray(s,1,2)),o!==s.length&&alert("Error calculating final array NP "+o+" !== "+s.length),s},getArrayCasteljau:function(){return s}}}function r(t,e,r,i){i=i||10;var n=function(t){function e(t,e){if(null==f)return f=t,a=e,o=t+1,void(l=e+1);t<f&&(f=t),t>o&&(o=t+1),e<a&&(a=e),e>l&&(l=e+1)}function r(t){for(i=+t[1],n=+t[2],e(i,n),s=5;s+1<t.length;s+=2)i+=+t[s],n+=+t[s+1],e(i,n)}var i,n,s,a,o,l,f=null;for(var u in t)"z"===t[u][0]&&r(t[u]);return{x:f,y:a,dx:o-f,dy:l-a}}(t),s=e*(1-2*i/100)/n.dx,a=r*(1-2*i/100)/n.dy;return s<a?a=s:s=a,{scalex:s,scaley:a,offsetx:-n.x+i/100*n.dx,offsety:-n.y+i/100*n.dy}}function i(t,r,i,n,s,a,o){t.beginPath(),t.moveTo(i,n);var l=+i,f=+n;if("jau"===r){var u=e(+i,+n,a,o);u.computePoints();for(var c=u.getArrayCasteljau(),h=2;h+5<c.length;h+=6)t.bezierCurveTo(c[h],c[h+1],c[h+2],c[h+3],c[h+4],c[h+5])}else{for(h=0;h<o.length;h+=2){var v=l,y=f;if("pol"===r)l=+o[h+0]+v,f=+o[h+1]+y,t.lineTo(l,f);else if("qua"==r)l=+o[h+2]+v,f=+o[h+3]+y,t.quadraticCurveTo(+o[h]+v,+o[h+1]+y,l,f),h+=2;else{if("cub"!=r&&"bez"!=r){console.log("ERROR: unknow form "+r+" calling trazoShape!");break}l=+o[h+4]+v,f=+o[h+5]+y,t.bezierCurveTo(+o[h]+v,+o[h+1]+y,+o[h+2]+v,+o[h+3]+y,l,f),h+=4}}a&&t.closePath()}}function n(t,e,r,i){var n=new Image;n.onload=function(){t.drawImage(n,+r,+i)},n.src=e}function s(e,r,i){var n=t(r[i]||i);"fill"in n&&(e.fillStyle=n.fill,e.fill()),"stroke-width"in n&&(e.lineWidth=n["stroke-width"]),e.strokeStyle="stroke"in n?n.stroke:"#000000",e.stroke()}function a(e,a,o){function l(t){return t}var f=a.getContext("2d"),u={},c=!o||o.autofit?r(e,a.width,a.height):o,h="scalex"in c;h&&(f.save(),f.lineWidth=1/c.scalex,f.scale(c.scalex,c.scaley),f.translate(c.offsetx,c.offsety));for(var v in e)if(e[v]&&!(e[v].length<3))if("defstyle"===e[v][0])u[e[v][1]]=l(e[v][2]);else if("img"===e[v][0])n(f,e[v][4],e[v][1],e[v][2]);else if("text"===e[v][0]||"txt"===e[v][0]){var y=t(u[e[v][3]]||e[v][3]);"fill"in y&&(f.fillStyle=y.fill,f.fillText(e[v][4],e[v][1],e[v][2])),"stroke"in y&&(f.strokeStyle=y.stroke,f.strokeText(e[v][4],e[v][1],e[v][2]))}else"rect"===e[v][0]||"rec"===e[v][0]?(f.rect(e[v][1],e[v][2],e[v][4],e[v][5]),s(f,u,e[v][3])):"circle"===e[v][0]||"cir"===e[v][0]?(f.beginPath(),f.ellipse(e[v][1],e[v][2],e[v][4],e[v][4],0,2*Math.PI,0),s(f,u,e[v][3])):"ellipse"===e[v][0]||"ell"===e[v][0]?(f.beginPath(),f.ellipse(e[v][1],e[v][2],e[v][4],e[v][5],0,2*Math.PI,0),s(f,u,e[v][3])):"z"===e[v][0]&&e[v].length>=6&&(i(f,e[v][4].substring(0,3),e[v][1],e[v][2],u[e[v][3]]||e[v][3],e[v][4].length>3&&"z"===e[v][4].substring(3),e[v].slice(5)),s(f,u,e[v][3]));h&&f.restore()}function o(e,r,i,n,s){var a=document.createElementNS(h,"text");a.setAttribute("x",+r),a.setAttribute("y",+i),a.textContent=s;var o=t(n);for(var l in o)a.setAttribute(l,o[l]);"stroke"in o||a.setAttribute("stroke","#000000"),e.appendChild(a)}function l(e,r,i,n,s){var a=document.createElementNS(h,"image");a.setAttribute("x",+r),a.setAttribute("y",+i),a.setAttribute("href",s);var o=t(n);for(var l in o)a.setAttribute(l,o[l]);e.appendChild(a)}function f(e,r){var i=document.createElementNS(h,e),n=t(r);for(var s in n)i.setAttribute(s,n[s]);return"stroke"in n||i.setAttribute("stroke","#000000"),i}function u(t,r,i,n,s,a,o){var l=f("path",s),u=["M "+i+" "+n+" "];if("jau"===r){var c=e(+i,+n,a,o);c.computePoints();var h=c.getArrayCasteljau();u.push(" C ");for(v=2;v+5<h.length;v+=6)u.push(h[v]+" "+h[v+1]+" "+h[v+2]+" "+h[v+3]+" "+h[v+4]+" "+h[v+5]+" ")}else{"pol"===r?u.push(" l "):"qua"==r?u.push(" q "):"cub"!=r&&"bez"!=r||u.push(" c ");for(var v=0;v<o.length;)if("pol"===r)u.push(o[v]+" "+o[v+1]+" "),v+=2;else if("qua"==r)u.push(o[v]+" "+o[v+1]+" "+o[v+2]+" "+o[v+3]+" "),v+=4;else{if("cub"!=r&&"bez"!=r){console.log("ERROR: unknow form "+r+" calling trazoShape!");break}u.push(o[v]+" "+o[v+1]+" "+o[v+2]+" "+o[v+3]+" "+o[v+4]+" "+o[v+5]+" "),v+=6}a&&u.push(" Z")}l.setAttribute("d",u.join("")),t.appendChild(l)}function c(t,e,i,n){function s(t){return t}var a={},p=document.createElementNS(h,"g"),g=i||{autofit:!0};if(g.autofit){var m=parseInt(e.style.width||v),x=parseInt(e.style.height||y);e.width&&e.width.baseVal&&(m=parseInt(e.width.baseVal.value)),e.height&&e.height.baseVal&&(x=parseInt(e.height.baseVal.value)),g=r(t,m,x)}"scalex"in g&&(p.setAttribute("stroke-width",""+1/g.scalex),p.setAttribute("transform"," scale     ("+g.scalex+", "+g.scaley+") translate ("+g.offsetx+", "+g.offsety+")")),e.appendChild(p);for(var A in t)if(t[A]&&!(t[A].length<3))if("defstyle"===t[A][0])a[t[A][1]]=s(t[A][2]);else if("gra"===t[A][0]||"graf"===t[A][0]||"graffiti"===t[A][0]){var b=t[A][3],z=d.indexOf(b)>-1,w=n?n[b]:null;if(w&&!z){var C=document.createElementNS(h,"svg");C.setAttribute("width",t[A][4]+"px"),C.setAttribute("height",t[A][5]+"px"),C.setAttribute("x",t[A][1]+"px"),C.setAttribute("y",t[A][2]+"px"),d.push(b),c(w,C,null,n),d.slice(-1,1),p.appendChild(C)}}else if("img"===t[A][0])l(p,t[A][1],t[A][2],a[t[A][3]]||t[A][3],t[A][4]);else if("text"===t[A][0]||"txt"===t[A][0])o(p,t[A][1],t[A][2],a[t[A][3]]||t[A][3],t[A][4]);else if("rect"===t[A][0]||"rec"===t[A][0]){(I=f("rect",a[t[A][3]]||t[A][3])).setAttribute("x",t[A][1]),I.setAttribute("y",t[A][2]),I.setAttribute("width",t[A][4]),I.setAttribute("height",t[A][5]),I.setAttribute("rx",t[A][6]||0),I.setAttribute("ry",t[A][7]||0),p.appendChild(I)}else if("circle"===t[A][0]||"cir"===t[A][0]){(I=f("circle",a[t[A][3]]||t[A][3])).setAttribute("cx",t[A][1]),I.setAttribute("cy",t[A][2]),I.setAttribute("r",t[A][4]),p.appendChild(I)}else if("ellipse"===t[A][0]||"ell"===t[A][0]){var I=f("ellipse",a[t[A][3]]||t[A][3]);I.setAttribute("cx",t[A][1]),I.setAttribute("cy",t[A][2]),I.setAttribute("rx",t[A][4]),I.setAttribute("ry",t[A][5]),p.appendChild(I)}else"z"===t[A][0]&&t[A].length>=6&&u(p,t[A][4].substring(0,3),t[A][1],t[A][2],a[t[A][3]]||t[A][3],t[A][4].length>3&&"z"==t[A][4].substring(3),t[A].slice(5))}var h="http://www.w3.org/2000/svg",v=300,y=200,d=[];return{renderCanvasGraffitis:function(t,e){var r=[].slice.call(document.getElementsByTagName("canvas"),0);for(var i in r){var n=r[i].id+" graffiti";t[n]&&a(t[n],r[i],e)}},renderSvgGraffitis:function(t,e){var r=[].slice.call(document.getElementsByTagNameNS(h,"svg"));for(var i in r){var n=r[i].id+" graffiti";t[n]&&c(t[n],r[i],e,t)}},renderClassGraffiti:function(t,e){var r=!!window.SVGSVGElement,i=[].slice.call(document.getElementsByClassName("graffiti"),0);for(var n in i){var s=i[n].id+" graffiti";if(t[s]){var o=parseInt(i[n].style.width||v),l=parseInt(i[n].style.height||y),f=r?document.createElementNS(h,"svg"):document.createElement("canvas");for(f.setAttribute("width",o+"px"),f.setAttribute("height",l+"px"),r?c(t[s],f,e,t):a(t[s],f,e);i[n].hasChildNodes();)i[n].removeChild(i[n].firstChild);i[n].appendChild(f)}}},drawGraffiti2canvas:a,trazoShape2canvas:i,drawGraffiti2svg:c,trazoShape2svg:u,autoCasteljau:e,convertPathArrayJ2C:function(t,r,i,n){var s=e(t,r,i,n);return s.computePoints(),s.getArrayCasteljau().slice(2)}}}vec3.prototype={toString:function(){return this.x+", "+this.y+", "+this.z},fromArray:function(t,e,r){r=r||3;var i=(e||0)*r;this.set(t[i],t[1+i],r>2?t[2+i]:0)},setIntoArray:function(t,e,r){r=r||3;var i=(e=e||t.length/r)*r;t[i]=this.x,t[i+1]=this.y,r>2&&(t[i+2]=this.z)},plus:function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},minus:function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},mult:function(t){this.x*=t,this.y*=t,this.z*=t},div:function(t){0===t&&(t=1e-20),this.x/=t,this.y/=t,this.z/=t},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){return new vec3(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},norm:function(){return Math.sqrt(this.dot(this))},normalize:function(){this.div(this.norm())},angle:function(t){return Math.acos(this.dot(t)/(this.norm()*t.norm()))},clone:function(){return new vec3(this.x,this.y,this.z)},set:function(t,e,r){t instanceof vec3?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=r||0)}};