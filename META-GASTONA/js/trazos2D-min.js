/*
trazos2D-min.js
is part of the open source project https://github.com/wakeupthecat/gastona

Copyright (C) 2015,2016 Alejandro Xalabarder Aulet
License : GNU General Public License (GPL) version 3

This program is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.
*/

function vec3(t,e,n){this.x=t||0,this.y=e||0,this.z=n||0}function vec3FromTo(t,e){var n=e.clone();return n.minus(t),n}function vec3FromArray(t,e,n){var i=new vec3;return i.fromArray(t,e,n),i}function trazos2D(){function t(t,e,n,i){function a(){if(!i||i.length<2)return[];var a,u=3*(2+i.length)-4,s=0;o=[];for(var f=new vec3,l=new vec3(t,e),d=new vec3,c=new vec3,v=0;v<i.length-3;v+=2)v>0&&l.fromArray(i,v/2-1,2),d.fromArray(i,v/2+0,2),c.fromArray(i,v/2+1,2),l.plus(f),d.plus(l),c.plus(d),f.set(l.x,l.y,l.z),a=r(l,d,c),l.setIntoArray(o,s+0,2),a[0].setIntoArray(o,s+2,2),a[1].setIntoArray(o,s+4,2),s+=3;return n?(u+=6,l=new vec3(t,e),a=r(d,c,l),d.setIntoArray(o,s+0,2),a[0].setIntoArray(o,s+2,2),c.setIntoArray(o,s+3,2),a[1].setIntoArray(o,s+4,2),d.fromArray(i,0,2),d.plus(l),a=r(c,l,d),a[0].setIntoArray(o,s+5,2),l.setIntoArray(o,s+6,2),a[1].setIntoArray(o,1,2)):(l=c.clone(),l.plus(vec3FromTo(d,c)),a=r(d,c,l),d.setIntoArray(o,s+0,2),a[0].setIntoArray(o,s+2,2),c.setIntoArray(o,s+3,2),l.set(t,e),d.fromArray(i,0,2),d.plus(l),c=l.clone(),c.plus(vec3FromTo(d,l)),a=r(c,l,d),a[0].setIntoArray(o,1,2)),u!==o.length&&alert("Error calculating final array NP "+u+" !== "+o.length),o}function r(t,e,n){var i=new vec3,a=new vec3,r=vec3FromTo(t,e),o=vec3FromTo(n,e),f=r.norm(),l=o.norm(),d=(f+l)*(f+l),c=vec3FromTo(o,r);c.div(d);var v=f>l?f*f:l*l,g=f*l,h=f/l;return 0>u&&(u=h>1?1/h:h),c.mult(s*(u*v+(1-u)*g)),i.set(e),a.set(e),i.minus(c),a.plus(c),[i,a]}var o=[],u=-1,s=.5;return{x0:t,y0:e,arrPtos:i,computePoints:a,getArrayCasteljau:function(){return o}}}function e(t,e,i,a){a=a||10;var r=n(t),o=e*(1-2*a/100)/r.dx,u=i*(1-2*a/100)/r.dy;return u>o?u=o:o=u,{scalex:o,scaley:u,offsetx:-r.x+a/100*r.dx,offsety:-r.y+a/100*r.dy}}function n(t){function e(t,e){return null==f?(f=t,o=e,u=t+1,void(s=e+1)):(f>t&&(f=t),t>u&&(u=t+1),o>e&&(o=e),void(e>s&&(s=e+1)))}function n(t){for(i=t[1],a=t[2],e(i,a),r=5;r+1<t.length;r+=2)i+=t[r],a+=t[r+1],e(i,a)}var i,a,r,o,u,s,f=null;for(var l in t)"z"===t[l][0]&&n(t[l]);return{x:f,y:o,dx:u-f,dy:s-o}}function i(e,n,i,a,r,o,u,s){if(e.beginPath(),e.moveTo(i,a),"jau"===n){var f=t(i,a,u,s);f.computePoints();for(var l=f.getArrayCasteljau(),d=2;d+5<l.length;d+=6)e.bezierCurveTo(l[d],l[d+1],l[d+2],l[d+3],l[d+4],l[d+5])}else{for(var d=0;d<s.length;)if("pol"===n)e.lineTo(s[d],s[d+1]),d+=2;else if("qua"==n)e.quadraticCurveTo(s[d],s[d+1],s[d+2],s[d+3]),d+=4;else{if("cub"!=n&&"bez"!=n){console.log("ERROR: unknow form "+n+" calling trazoShape!");break}e.bezierCurveTo(s[d],s[d+1],s[d+2],s[d+3],s[d+4],s[d+5]),d+=6}u&&e.closePath()}r&&(e.fillStyle=r),o&&(e.strokeStyle=o),r&&e.fill(),o&&e.stroke()}function a(t,n,a){function r(t){return t}var o=n.getContext("2d");a=a!==!1;var u={};if(a){var s=e(t,n.width,n.height);o.save(),o.lineWidth=1/s.scalex,o.scale(s.scalex,s.scaley),o.translate(s.offsetx,s.offsety)}for(var f in t)t[f]&&t[f].length>=3&&("defstyle"===t[f][0]?u[t[f][1]]=r(t[f][2]):"z"!==t[f][0]||t[f].length<6||i(o,t[f][4].substring(0,3),t[f][1],t[f][2],u[t[f][3]]||t[f][3],"#000000",t[f][4].length>3&&"z"===t[f][4].substring(3),t[f].slice(5)));a&&o.restore()}function r(e,n,i,a,r,o,u,f){var l=document.createElementNS(s,"path");l.setAttribute("stroke",o||"#000000"),l.setAttribute("fill",r||"none");var d=["M "+i+" "+a+" "];if("jau"===n){var c=t(i,a,u,f);c.computePoints();var v=c.getArrayCasteljau();d.push(" C ");for(var g=2;g+5<v.length;g+=6)d.push(v[g]+" "+v[g+1]+" "+v[g+2]+" "+v[g+3]+" "+v[g+4]+" "+v[g+5]+" ")}else{"pol"===n?d.push(" L "):"qua"==n?d.push(" Q "):("cub"==n||"bez"==n)&&d.push(" C ");for(var g=0;g<f.length;)if("pol"===n)d.push(f[g]+" "+f[g+1]+" "),g+=2;else if("qua"==n)d.push(f[g]+" "+f[g+1]+" "+f[g+2]+" "+f[g+3]+" "),g+=4;else{if("cub"!=n&&"bez"!=n){console.log("ERROR: unknow form "+n+" calling trazoShape!");break}d.push(f[g]+" "+f[g+1]+" "+f[g+2]+" "+f[g+3]+" "+f[g+4]+" "+f[g+5]+" "),g+=6}u&&d.push(" Z")}l.setAttribute("d",d.join("")),e.appendChild(l)}function o(t,n,i){function a(t){return t}var o={},u=document.createElementNS(s,"g");if(i!==!1){var f=e(t,n.width.baseVal.value,n.height.baseVal.value);u.setAttribute("stroke-width",""+1/f.scalex),u.setAttribute("transform"," scale     ("+f.scalex+", "+f.scaley+") translate ("+f.offsetx+", "+f.offsety+")")}n.appendChild(u);for(var l in t)t[l]&&t[l].length>=3&&("defstyle"===t[l][0]?o[t[l][1]]=a(t[l][2]):"z"!==t[l][0]||t[l].length<6||r(u,t[l][4].substring(0,3),t[l][1],t[l][2],o[t[l][3]]||t[l][3],"#000000",t[l][4].length>3&&"z"==t[l][4].substring(3),t[l].slice(5)))}function u(t){var e=document.getElementsByTagName("canvas"),n="";for(var i in e)n=e[i].id+" graffiti",t[n]&&a(t[n],e[i]);var e=document.getElementsByTagNameNS(s,"svg");for(var i in e)n=e[i].id+" graffiti",t[n]&&o(t[n],e[i])}var s="http://www.w3.org/2000/svg";return{renderAllGraffitis:u,drawGrafitti2canvas:a,trazoShape2canvas:i,drawGrafitti2svg:o,trazoShape2svg:r,autoCasteljau:t}}vec3.prototype={toString:function(){return this.x+", "+this.y+", "+this.z},fromArray:function(t,e,n){n=n||3;var i=(e||0)*n;this.set(t[i],t[1+i],n>2?t[2+i]:0)},setIntoArray:function(t,e,n){n=n||3,e=e||t.length/n;var i=e*n;t[i]=this.x,t[i+1]=this.y,n>2&&(t[i+2]=this.z)},plus:function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},minus:function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},mult:function(t){this.x*=t,this.y*=t,this.z*=t},div:function(t){0===t&&(t=1e-20),this.x/=t,this.y/=t,this.z/=t},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){return new vec3(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},norm:function(){return Math.sqrt(this.dot(this))},normalize:function(){this.div(this.norm())},angle:function(t){return Math.acos(this.dot(t)/(this.norm()*t.norm()))},clone:function(){return new vec3(this.x,this.y,this.z)},set:function(t,e,n){t instanceof vec3?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0)}};
